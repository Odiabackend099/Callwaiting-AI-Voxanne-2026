# ğŸ—ï¸ PHASE 6 ARCHITECTURE & FLOW DIAGRAMS

## ğŸ¯ SCENARIO 2: LIVE BOOKING CHAIN

### Request Flow (Vapi â†’ API â†’ DB â†’ Calendar)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PATIENT CALL (Vapi)                                             â”‚
â”‚ "I'd like to book an appointment on Friday at 2 PM"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VAPI GENERATES TOOL CALL                                        â”‚
â”‚ {                                                               â”‚
â”‚   "tool": "book_appointment",                                   â”‚
â”‚   "params": {                                                   â”‚
â”‚     "clinic_id": "uuid-clinic",                                â”‚
â”‚     "provider_id": "uuid-provider",                            â”‚
â”‚     "patient_name": "John Doe",                                â”‚
â”‚     "patient_email": "john@example.com",                       â”‚
â”‚     "appointment_time": "2026-01-17T14:00:00Z",               â”‚
â”‚     "duration_minutes": 30                                      â”‚
â”‚   }                                                             â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/vapi/tools                                            â”‚
â”‚ Authorization: Bearer JWT (org_id claim)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Validate   â”‚ â”‚ Verify   â”‚ â”‚ Check JWTâ†’Clinic
    â”‚ Parameters â”‚ â”‚ Provider â”‚ â”‚ org_id match
    â”‚ Required   â”‚ â”‚ Exists   â”‚ â”‚ (403 if no)
    â”‚ Fields     â”‚ â”‚ In org   â”‚ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ATOMIC SLOT LOCKING (Pessimistic)                               â”‚
â”‚ SELECT * FROM appointments                                      â”‚
â”‚ WHERE provider_id = $1                                          â”‚
â”‚   AND scheduled_at <= $2                                        â”‚
â”‚   AND (scheduled_at + duration) > $2                            â”‚
â”‚ FOR UPDATE;  â† LOCK acquired by this transaction                â”‚
â”‚                                                                  â”‚
â”‚ â° Only 1 transaction can proceed                                â”‚
â”‚ ğŸš« Others wait or get: 409 CONFLICT                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CHECK FOR CONFLICTS                                             â”‚
â”‚ âœ“ No overlapping appointments?                                  â”‚
â”‚ âœ“ Slot available?                                               â”‚
â”‚ âœ“ Provider not at capacity?                                     â”‚
â”‚                                                                  â”‚
â”‚ If conflicts: RELEASE LOCK â†’ 409 Conflict                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INSERT APPOINTMENT                                              â”‚
â”‚ INSERT INTO appointments (                                      â”‚
â”‚   id, org_id, clinic_id, provider_id,                          â”‚
â”‚   patient_name, patient_email, scheduled_at,                   â”‚
â”‚   duration_minutes, status, created_at                         â”‚
â”‚ ) VALUES (...)                                                  â”‚
â”‚                                                                  â”‚
â”‚ âœ… org_id = JWT.org_id (enforced by RLS)                        â”‚
â”‚ âœ… status = 'booked'                                             â”‚
â”‚ âœ… created_at = now()                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LOCK RELEASED                                                   â”‚
â”‚ Transaction commits â†’ other transactions can now proceed        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PostgreSQL â”‚ â”‚ Background   â”‚ â”‚ Return 200   â”‚
    â”‚ Trigger    â”‚ â”‚ Job: Sync    â”‚ â”‚ Response     â”‚
    â”‚ Fires      â”‚ â”‚ Google       â”‚ â”‚ (already     â”‚
    â”‚ Auto       â”‚ â”‚ Calendar     â”‚ â”‚  started)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚
         â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ INSERT INTO calendar_events    â”‚
    â”‚ (org_id, appointment_id,       â”‚
    â”‚  google_event_id, synced_at)   â”‚
    â”‚                                 â”‚
    â”‚ âœ… Async (doesn't block         â”‚
    â”‚    appointment response)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SYNC TO GOOGLE CALENDAR        â”‚
    â”‚ 1. Create calendar event       â”‚
    â”‚ 2. Store google_event_id       â”‚
    â”‚ 3. Return calendar link        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… RESPONSE (< 500ms)                                            â”‚
â”‚ {                                                               â”‚
â”‚   "success": true,                                              â”‚
â”‚   "appointment": {                                              â”‚
â”‚     "id": "apt-uuid",                                           â”‚
â”‚     "org_id": "clinic-uuid",                                    â”‚
â”‚     "clinic_id": "clinic-uuid",                                â”‚
â”‚     "provider_id": "provider-uuid",                             â”‚
â”‚     "patient_name": "John Doe",                                â”‚
â”‚     "patient_email": "john@example.com",                       â”‚
â”‚     "scheduled_at": "2026-01-17T14:00:00Z",                    â”‚
â”‚     "duration_minutes": 30,                                     â”‚
â”‚     "status": "booked",                                         â”‚
â”‚     "created_at": "2026-01-15T10:30:45.123Z"                   â”‚
â”‚   },                                                            â”‚
â”‚   "google_calendar_event_id": "event-id",                      â”‚
â”‚   "calendar_sync": {                                            â”‚
â”‚     "event_id": "google-event-id",                             â”‚
â”‚     "synced_at": "2026-01-15T10:30:45.500Z",                   â”‚
â”‚     "calendar_link": "https://calendar.google.com/..."         â”‚
â”‚   }                                                             â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VAPI CONFIRMATION TO PATIENT                                    â”‚
â”‚ "Perfect! I've booked your appointment with Dr. Smith"         â”‚
â”‚ "on Friday, January 17th at 2:00 PM. You'll receive a"        â”‚
â”‚ "confirmation email. It's also on your Google Calendar."       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” CLINIC ISOLATION ARCHITECTURE

### Multi-Layer Isolation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PATIENT CALL                                                    â”‚
â”‚ "Book me at Clinic B" (but patient of Clinic A)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 1: API VALIDATION (Application Level)                    â”‚
â”‚                                                                  â”‚
â”‚ Extract org_id from JWT                                        â”‚
â”‚ Get clinic_id from request                                     â”‚
â”‚ Verify: org_id matches clinic.org_id                           â”‚
â”‚                                                                  â”‚
â”‚ IF NOT MATCH:                                                   â”‚
â”‚   Return 403 Forbidden â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                                       â”‚ Early rejection
â”‚                                       â”‚ (fast fail)
â”‚ IF MATCH:                             â”‚
â”‚   Continue to database                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 2: RLS POLICY (Database Level)                            â”‚
â”‚                                                                  â”‚
â”‚ PostgreSQL RLS Policy:                                          â”‚
â”‚                                                                  â”‚
â”‚ CREATE POLICY org_isolation ON appointments                     â”‚
â”‚   USING (org_id = auth.jwt()->>'org_id')                       â”‚
â”‚   WITH CHECK (org_id = auth.jwt()->>'org_id');                 â”‚
â”‚                                                                  â”‚
â”‚ INSERT appointment:                                             â”‚
â”‚   âœ“ org_id in JWT = clinic A                                   â”‚
â”‚   âœ— org_id in INSERT = clinic B                                â”‚
â”‚   â†’ RLS BLOCKS â†’ Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                                         â”‚ Layer 2
â”‚ SELECT appointments:                    â”‚ rejection
â”‚   JWT has org_id = clinic A             â”‚
â”‚   Try SELECT WHERE org_id = clinic B    â”‚
â”‚   â†’ RLS BLOCKS â†’ Empty result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 3: AUDIT LOGGING (Security Level)                        â”‚
â”‚                                                                  â”‚
â”‚ Trigger on RLS violation:                                       â”‚
â”‚                                                                  â”‚
â”‚ INSERT INTO audit_log (                                         â”‚
â”‚   user_id = 'clinic-a-user',                                   â”‚
â”‚   action = 'attempted_cross_org_access',                       â”‚
â”‚   target_org_id = 'clinic-b-id',                               â”‚
â”‚   status = 'blocked',                                           â”‚
â”‚   details = {                                                   â”‚
â”‚     'attempted_org_id': 'clinic-b',                            â”‚
â”‚     'authenticated_org_id': 'clinic-a'                         â”‚
â”‚   }                                                             â”‚
â”‚ )                                                               â”‚
â”‚                                                                  â”‚
â”‚ Result: Security violation logged for investigation             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Result: 3-layer protection ensures zero data leakage
  Layer 1: Fast rejection at API
  Layer 2: Absolute enforcement at database
  Layer 3: Full audit trail for investigation
```

---

## âš¡ RACE CONDITION PREVENTION

### Atomic Locking Flow

```
Time â†’

User A Request          User B Request
â”‚                       â”‚
â”œâ”€ POST /api/vapi/tools â”œâ”€ POST /api/vapi/tools (2ms later)
â”‚                       â”‚
â”œâ”€ Extract JWT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  org_id = clinic-a    â”œâ”€ Extract JWT
â”‚                       â”‚  org_id = clinic-a
â”œâ”€ SELECT ... FOR UPDATEâ”‚
â”‚  (lock acquired) â—„â”€â”€â”€â”€â”€â”¤
â”‚                       â”œâ”€ SELECT ... FOR UPDATE
â”‚                       â”‚  WAITING FOR LOCK â³
â”‚  Checks:              â”‚
â”‚  âœ“ Slot available     â”‚
â”‚  âœ“ No conflicts       â”‚
â”‚                       â”‚
â”œâ”€ INSERT appointment   â”‚
â”‚  âœ… SUCCESS           â”‚
â”‚                       â”‚
â”œâ”€ COMMIT transaction   â”‚
â”‚  (lock released) â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       â”‚    â”‚
â”‚                       â”‚    â”œâ”€ Lock acquired
â”‚                       â”‚    â”‚
â”‚                       â”‚    â”œâ”€ Checks:
â”‚                       â”‚    â”‚  âœ— Slot occupied! (User A booked it)
â”‚                       â”‚    â”‚
â”‚                       â”‚    â”œâ”€ DELETE lock + ROLLBACK
â”‚                       â”‚    â”‚  âŒ CONFLICT (409)
â”‚                       â”‚    â”‚
â”‚                       â”‚    â””â”€ Return error to User B

Result: Only 1 appointment created, 1 gets 409 Conflict
Database prevented race condition atomically âœ…
```

---

## ğŸ“Š DATABASE SCHEMA (Multi-Tenant)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ organizations (root)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚ name                â”‚                                        â”‚
â”‚ created_at          â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–²
          â”‚ org_id FK
          â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                             â”‚                  â”‚
          â–¼                             â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ profiles         â”‚        â”‚ appointments     â”‚  â”‚ knowledge_   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ base         â”‚
â”‚ id               â”‚        â”‚ id               â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ org_id â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ org_id          â”‚  â”‚ id           â”‚
â”‚ email            â”‚        â”‚ clinic_id        â”‚  â”‚ org_id â—„â”€â”€â”€â”€â”€â”¼â”€â”€â”
â”‚ role             â”‚        â”‚ provider_id â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â–¶ profiles   â”‚
â”‚ created_at       â”‚        â”‚ patient_name     â”‚  â”‚ content      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ patient_email    â”‚  â”‚ embedding    â”‚
          â–²                 â”‚ scheduled_at     â”‚  â”‚ (pgvector)   â”‚
          â”‚                 â”‚ duration_minutes â”‚  â”‚ created_at   â”‚
          â”‚                 â”‚ status           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚ created_at       â”‚
          â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                        â”‚ FK provider_id
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RLS Policy on all tables:
  SELECT WHERE org_id = auth.jwt()->>'org_id'
  INSERT WHERE org_id = auth.jwt()->>'org_id'
  UPDATE WHERE org_id = auth.jwt()->>'org_id'
  DELETE WHERE org_id = auth.jwt()->>'org_id'

Result: Clinic A cannot see/modify Clinic B data
        At database layer (cannot be bypassed)
```

---

## ğŸ“Š PERFORMANCE TARGETS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 2: LIVE BOOKING CHAIN TARGET: <500ms             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Typical breakdown:                                           â”‚
â”‚                                                              â”‚
â”‚  JWT Parse + Validation     â”¤ 5ms                           â”‚
â”‚  Provider lookup            â”¤ 15ms                          â”‚
â”‚  Conflict check + locking   â”¤ 20ms  â—„â”€ SELECT FOR UPDATE   â”‚
â”‚  INSERT appointment         â”¤ 10ms                          â”‚
â”‚  RLS check at DB            â”¤ 5ms                           â”‚
â”‚  Network latency            â”¤ 50-100ms                      â”‚
â”‚  Trigger fire (async)       â”¤ 0ms (non-blocking)           â”‚
â”‚  Google Calendar sync (bg)  â”¤ 0ms (enqueued, not waited)   â”‚
â”‚                             â•â•â•â•â•â•â•â•â•â•â•â•â•                  â”‚
â”‚  Total: ~110-150ms (with network)                           â”‚
â”‚  Max budget: 500ms                                          â”‚
â”‚  Buffer: 350ms for slower networks/loads                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 3: RAG SMART ANSWER TARGET: <100ms               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ pgvector similarity search:                                 â”‚
â”‚                                                              â”‚
â”‚  Generate embedding (local)         â”¤ 5ms                  â”‚
â”‚  pgvector cosine distance calc      â”¤ 10-20ms              â”‚
â”‚  RLS filter (org_id)                â”¤ 2ms                  â”‚
â”‚  Fetch top 3 results                â”¤ 5-10ms               â”‚
â”‚  Network round-trip                 â”¤ 50-80ms              â”‚
â”‚                             â•â•â•â•â•â•â•â•â•â•â•â•â•                  â”‚
â”‚  Total: ~72-117ms                                           â”‚
â”‚                                                              â”‚
â”‚ Buffer: If >100ms, needs query optimization                â”‚
â”‚         (add index on org_id, embedding type)              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ TEST COVERAGE MAP

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 2: 8 TEST CASES                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Test 1: Happy path                                          â”‚
â”‚  âœ“ Booking created                                          â”‚
â”‚  âœ“ Google Calendar synced                                   â”‚
â”‚  âœ“ <500ms performance                                       â”‚
â”‚                                                              â”‚
â”‚ Test 2: Conflict detection                                  â”‚
â”‚  âœ“ Overlapping booking rejected (409)                       â”‚
â”‚  âœ“ First appointment unchanged                              â”‚
â”‚                                                              â”‚
â”‚ Test 3: Adjacent appointments                               â”‚
â”‚  âœ“ Back-to-back bookings allowed                            â”‚
â”‚  âœ“ No false conflicts                                       â”‚
â”‚                                                              â”‚
â”‚ Test 4: Cross-clinic isolation                              â”‚
â”‚  âœ“ Different clinic booking rejected (403)                  â”‚
â”‚  âœ“ RLS policy enforced                                      â”‚
â”‚                                                              â”‚
â”‚ Test 5: Race condition prevention                           â”‚
â”‚  âœ“ 2 concurrent requests â†’ 1 success, 1 conflict            â”‚
â”‚  âœ“ Atomic locking works                                     â”‚
â”‚                                                              â”‚
â”‚ Test 6: Invalid provider                                    â”‚
â”‚  âœ“ Non-existent provider rejected (404)                     â”‚
â”‚                                                              â”‚
â”‚ Test 7: Missing auth                                        â”‚
â”‚  âœ“ No JWT token rejected (401)                              â”‚
â”‚                                                              â”‚
â”‚ Test 8: Metadata validation                                 â”‚
â”‚  âœ“ All fields stored correctly                              â”‚
â”‚  âœ“ Database values match response                           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Coverage: All critical paths + edge cases + security
```

---

## âœ¨ KEY DESIGN PRINCIPLES

```
1. ORG_ID FIRST
   â””â”€ Every record has org_id = clinic UUID
      â””â”€ Every query filters: WHERE org_id = current_org
         â””â”€ Result: Impossible to leak cross-org data

2. REAL PIPES, FAKE SIGNALS
   â””â”€ Real: Supabase database, RLS, JWT
      â””â”€ Fake: In-memory fixtures, mock Calendar API
         â””â”€ Result: Tests real behavior without external deps

3. ATOMIC OPERATIONS
   â””â”€ SELECT ... FOR UPDATE prevents race conditions
      â””â”€ Database enforces atomicity, not app logic
         â””â”€ Result: Impossible to double-book

4. PERFORMANCE FIRST
   â””â”€ <500ms for booking (voice AI responsiveness)
      â””â”€ <100ms for RAG (conversation quality)
         â””â”€ Result: Users don't wait or perceive lag

5. MULTI-LAYER SECURITY
   â””â”€ Layer 1: API validation (fast fail)
      â””â”€ Layer 2: RLS policy (absolute enforcement)
         â””â”€ Layer 3: Audit logging (investigation)
            â””â”€ Result: Defense in depth
```

---

**Architecture: âœ… COMPLETE**  
**Ready for Implementation: âœ… YES**
