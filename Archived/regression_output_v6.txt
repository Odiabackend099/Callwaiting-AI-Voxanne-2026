
> voxanne-backend@1.0.0 test:regression
> jest --config jest.regression.config.js

  console.log
    [WebSocket] Server initialized for /api/web-voice/*

      at Object.log (src/server.ts:342:9)

  console.log
    [WebSocket] Server initialized for /ws/live-calls/*

      at Object.log (src/server.ts:346:9)

FAIL src/tests/regression/regression.test.ts (19.75 s)
  Regression Tests - Full System Audit
    Auth System - Existing Functionality
      JWT Token Generation
        ✓ should generate valid JWT tokens during setup (9 ms)
        ✓ should allow access to protected routes with valid token (1124 ms)
      Role-Based Access
        ✓ should allow authenticated users to view their organization
    Organization System - Existing Functionality
      Organization Validation
        ✓ should still reject invalid UUIDs in routes (523 ms)
      Multi-tenant Isolation
        ✓ should return contacts only for the users organization (1 ms)
    Calendar Booking - Existing Functionality
      Booking Lifecycle
        ✓ should create a booking successfully (2205 ms)
    Agent System - Existing Functionality
      Agent Retrieval
        ✕ should list agents for the organization (780 ms)
    Call System - Existing Functionality
      Call History
        ✕ should retrieve calls scoped by organization (7 ms)
    API Layer - Existing Functionality
      ✓ should return 401 for protected routes without token (4 ms)
      ✓ should return 404 for non-existent endpoints (3 ms)
    Performance - Existing Baselines
      ✕ should respond to health check within 200ms (783 ms)

  ● Regression Tests - Full System Audit › Agent System - Existing Functionality › Agent Retrieval › should list agents for the organization

    expect(received).toBeDefined()

    Received: undefined

      123 |                 // Should find the test agent created in setup
      124 |                 const found = response.body.find((a: any) => a.id === testContext.testAgentId);
    > 125 |                 expect(found).toBeDefined();
          |                               ^
      126 |             });
      127 |         });
      128 |     });

      at Object.<anonymous> (src/tests/regression/regression.test.ts:125:31)

  ● Regression Tests - Full System Audit › Call System - Existing Functionality › Call History › should retrieve calls scoped by organization

    expected 200 "OK", got 401 "Unauthorized"

      135 |                     .get('/api/calls')
      136 |                     .set('Authorization', `Bearer ${testContext.adminToken}`)
    > 137 |                     .expect(200);
          |                      ^
      138 |
      139 |                 // Note: response structure might be { calls: [], count: 0 } or just []
      140 |                 const calls = Array.isArray(response.body) ? response.body : response.body.calls || [];

      at Object.<anonymous> (src/tests/regression/regression.test.ts:137:22)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ● Regression Tests - Full System Audit › Performance - Existing Baselines › should respond to health check within 200ms

    expect(received).toBeLessThan(expected)

    Expected: < 200
    Received:   782

      166 |             await request(app).get('/health').expect(200);
      167 |             const duration = Date.now() - start;
    > 168 |             expect(duration).toBeLessThan(200);
          |                              ^
      169 |         });
      170 |     });
      171 | });

      at Object.<anonymous> (src/tests/regression/regression.test.ts:168:30)

----------------------------------|---------|----------|---------|---------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File                              | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                                                                                                                                                                         
----------------------------------|---------|----------|---------|---------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All files                         |   13.62 |     2.43 |    6.84 |   13.97 |                                                                                                                                                                                                                                                                                                           
 src                              |   49.27 |     16.5 |   21.42 |   49.63 |                                                                                                                                                                                                                                                                                                           
  server.ts                       |   49.27 |     16.5 |   21.42 |   49.63 | 15,132-137,160,181-182,252-253,261-278,287-289,303,318,323-324,353-422,428-542,548-639,645-648,653-656                                                                                                                                                                                                    
 src/config                       |   69.69 |    45.45 |      60 |   68.96 |                                                                                                                                                                                                                                                                                                           
  index.ts                        |   69.69 |    45.45 |      60 |   68.96 | 33,54,216-237,264,278-279                                                                                                                                                                                                                                                                                 
 src/jobs                         |    9.41 |        0 |       0 |    9.45 |                                                                                                                                                                                                                                                                                                           
  orphan-recording-cleanup.ts     |    6.41 |        0 |       0 |    6.41 | 27-90,99-181,190-207                                                                                                                                                                                                                                                                                      
  recording-metrics-monitor.ts    |   22.58 |        0 |       0 |   22.58 | 24-92,102-123                                                                                                                                                                                                                                                                                             
  recording-queue-worker.ts       |    7.89 |        0 |       0 |    7.96 | 39-263,272-385,395-425                                                                                                                                                                                                                                                                                    
 src/middleware                   |    28.9 |       25 |      25 |   29.36 |                                                                                                                                                                                                                                                                                                           
  auth.ts                         |    28.3 |    26.82 |   33.33 |   28.57 | 42-43,59-85,104-115,128-129,135-136,143-144,155-157,168-169,178-196,204-239,248-280                                                                                                                                                                                                                       
  rate-limit.ts                   |   66.66 |      100 |       0 |   66.66 | 13,30                                                                                                                                                                                                                                                                                                     
  validation.ts                   |   18.75 |        0 |      25 |      20 | 11-52                                                                                                                                                                                                                                                                                                     
 src/prompts                      |      20 |        0 |       0 |      20 |                                                                                                                                                                                                                                                                                                           
  outbound-agent-template.ts      |      20 |        0 |       0 |      20 | 37-39,188-209,216,231-290                                                                                                                                                                                                                                                                                 
 src/routes                       |    9.98 |     0.86 |    2.46 |   10.33 |                                                                                                                                                                                                                                                                                                           
  agent-sync.ts                   |      10 |        0 |       0 |      10 | 32-355                                                                                                                                                                                                                                                                                                    
  analytics.ts                    |   22.58 |        0 |       0 |   22.58 | 13-49,58-78                                                                                                                                                                                                                                                                                               
  appointments.ts                 |   22.91 |     8.53 |   33.33 |   24.26 | 29-87,121,143-144,150-155,185-188,202-254,265-286,297-368                                                                                                                                                                                                                                                 
  assistants.ts                   |   11.41 |     2.58 |      20 |   12.13 | 10,19-23,31-54,98-177,182-339,347-357,375-380,388-474,482-600,623-681,696-711                                                                                                                                                                                                                             
  book-demo.ts                    |      30 |        0 |       0 |      30 | 10-142                                                                                                                                                                                                                                                                                                    
  calendar-oauth.ts               |   15.78 |        0 |       0 |   15.78 | 24-56,72-168,177-211,223-254                                                                                                                                                                                                                                                                              
  calls-dashboard.ts              |    7.89 |        0 |       0 |    9.09 | 23-171,182-260,270-329,339-434,443-502,511-532                                                                                                                                                                                                                                                            
  calls.ts                        |   12.25 |     1.53 |    6.25 |   11.92 | 23-48,53-178,186-258,266-273,281-353,359-404,414-430                                                                                                                                                                                                                                                      
  contacts.ts                     |   24.69 |    11.86 |   16.66 |   25.97 | 25-49,88-89,97-98,111-112,150,169-170,176-181,192-238,254-309,320-341,353-410,422-489                                                                                                                                                                                                                     
  dashboard-leads.ts              |   19.44 |        0 |       0 |   21.21 | 15-69                                                                                                                                                                                                                                                                                                     
  escalation-rules.ts             |   13.51 |        0 |       0 |   13.51 | 18-43,52-106,115-145,154-172,181-206                                                                                                                                                                                                                                                                      
  founder-console-settings.ts     |     6.4 |        0 |       0 |    6.66 | 38-63,83-587,597-612,621-662                                                                                                                                                                                                                                                                              
  founder-console-v2.ts           |    5.39 |        0 |       0 |    5.56 | 39-44,82-159,299-306,314-329,343,352,368-421,430-483,507-797,807-812,826-1212,1228-1684,1700-2036,2052-2208,2225-2279,2321-2515,2527-2559,2575-2880,2890-2973,2982-3023,3033-3074,3087-3150,3168-3659,3673-3736,3746-3806,3818-3821,3831-3849,3859-3891,3900-3918,3927-3951,3960-3980,3994-4046,4056-4082 
  handoff-routes.ts               |   27.58 |        0 |       0 |   27.58 | 10,15-30,36-55                                                                                                                                                                                                                                                                                            
  inbound-setup.ts                |    6.17 |        0 |       0 |    6.17 | 16-29,37-352,364-440,449-485                                                                                                                                                                                                                                                                              
  integrations-byoc.ts            |    12.5 |        0 |       0 |   12.72 | 49-115,127-194,204-270,280-313,326-365,379-391                                                                                                                                                                                                                                                            
  integrations-status.ts          |   23.68 |        0 |       0 |   23.68 | 34-42,83-115,138-167,180-196                                                                                                                                                                                                                                                                              
  knowledge-base-rag.ts           |   19.69 |        0 |       0 |   21.31 | 23-104,113-145,154-175                                                                                                                                                                                                                                                                                    
  knowledge-base.ts               |    6.38 |        0 |       0 |    7.03 | 19-48,64-248,256-293,298-405,410-511,516-579,584-661,666-914                                                                                                                                                                                                                                              
  notifications.ts                |   12.14 |        0 |       0 |   12.74 | 27-98,108-144,155-193,204-237,252-293                                                                                                                                                                                                                                                                     
  phone-mapping-routes.ts         |   15.38 |        0 |       0 |   16.21 | 9-23,35-105,117-140,153-183,195-232                                                                                                                                                                                                                                                                       
  phone-numbers.ts                |   16.66 |        0 |       0 |   17.17 | 40-74,81-155,161-168,174-181,187-239,245-256                                                                                                                                                                                                                                                              
  sms-status-webhook.ts           |    12.5 |        0 |       0 |   12.96 | 32-215                                                                                                                                                                                                                                                                                                    
  team.ts                         |   10.86 |        0 |       0 |   11.11 | 16-24,32-75,84-155,164-214,223-254,263                                                                                                                                                                                                                                                                    
  vapi-discovery.ts               |    12.5 |        0 |       0 |   13.15 | 35-75,84-124,134-193,202-228                                                                                                                                                                                                                                                                              
  vapi-rag-integration.ts         |   26.92 |        0 |       0 |   26.92 | 25-60,77-101                                                                                                                                                                                                                                                                                              
  vapi-setup.ts                   |   25.64 |        8 |       0 |   27.02 | 29-128                                                                                                                                                                                                                                                                                                    
  vapi-tools-routes.ts            |   12.05 |        0 |       0 |   12.05 | 15-46,51,76-123,158-207,242-303,339-420,455-527,541-609,624-655                                                                                                                                                                                                                                           
  vapi-tools.ts                   |    5.12 |        0 |       0 |    5.12 | 23-480                                                                                                                                                                                                                                                                                                    
  vapi-webhook.ts                 |    23.8 |        0 |       0 |   24.19 | 36-137,142                                                                                                                                                                                                                                                                                                
  webhooks.ts                     |    4.56 |        0 |       0 |    4.63 | 56-65,86-204,251-947,973-1947,1965-1997                                                                                                                                                                                                                                                                   
 src/schemas                      |   83.33 |        0 |       0 |   83.33 |                                                                                                                                                                                                                                                                                                           
  founder-console.ts              |   83.33 |        0 |       0 |   83.33 | 25                                                                                                                                                                                                                                                                                                        
 src/services                     |   12.05 |     2.14 |    6.99 |   12.47 |                                                                                                                                                                                                                                                                                                           
  analytics-service.ts            |    5.33 |        0 |       0 |    6.25 | 17-189                                                                                                                                                                                                                                                                                                    
  atomic-booking-service.ts       |    4.12 |        0 |       0 |    4.12 | 32-394                                                                                                                                                                                                                                                                                                    
  booking-confirmation-service.ts |     9.8 |        0 |       0 |     9.8 | 41-240                                                                                                                                                                                                                                                                                                    
  cache.ts                        |   26.82 |        0 |    7.14 |    28.2 | 27-99,110,117,124,131,138                                                                                                                                                                                                                                                                                 
  calendar-integration.ts         |    7.24 |        0 |       0 |    7.46 | 36-131,147-207,226-261                                                                                                                                                                                                                                                                                    
  calendar-slot-service.ts        |   17.24 |        0 |       0 |   17.24 | 22-95                                                                                                                                                                                                                                                                                                     
  call-recording-storage.ts       |    6.61 |      5.4 |       0 |    6.71 | 44-117,129-379,389-408,417-437                                                                                                                                                                                                                                                                            
  call-type-detector.ts           |   14.28 |        0 |       0 |    14.7 | 20-26,48-111,125-149                                                                                                                                                                                                                                                                                      
  csv-import-service.ts           |    7.26 |        0 |       0 |    7.65 | 94-122,133-217,228-696,704-715,724-742,750-757,765-794                                                                                                                                                                                                                                                    
  document-chunker.ts             |    7.93 |        0 |       0 |    8.19 | 26-138,148-153,163-165                                                                                                                                                                                                                                                                                    
  email-service.ts                |   18.51 |        0 |       0 |   18.51 | 27-32,46-76,93-194                                                                                                                                                                                                                                                                                        
  embeddings.ts                   |   18.18 |     1.96 |       0 |   19.04 | 17,33,41-100,108-185,198-210                                                                                                                                                                                                                                                                              
  encryption.ts                   |   17.64 |        0 |       0 |   17.64 | 24-102                                                                                                                                                                                                                                                                                                    
  google-oauth-service.ts         |      10 |        0 |       0 |      10 | 20-31,46-67,83-175,187-266,277-306                                                                                                                                                                                                                                                                        
  handoff-service.ts              |   16.66 |        0 |       0 |   16.66 | 40-111                                                                                                                                                                                                                                                                                                    
  integration-decryptor.ts        |    5.66 |     1.04 |       0 |    5.69 | 97-712                                                                                                                                                                                                                                                                                                    
  integration-settings.ts         |    9.52 |        0 |       0 |    9.52 | 34-122                                                                                                                                                                                                                                                                                                    
  lead-scoring.ts                 |    9.25 |        0 |       0 |   11.23 | 68-158,180-206,213-221,229,237-253                                                                                                                                                                                                                                                                        
  logger.ts                       |      52 |    35.29 |   52.38 |      52 | 38,52,64-77,94-104,115-138,147,156-160,172,174-177                                                                                                                                                                                                                                                        
  org-validation.ts               |   16.12 |        0 |       0 |   16.12 | 24-49,64-79,91-96,112-125                                                                                                                                                                                                                                                                                 
  rag-context-provider.ts         |   15.51 |        0 |       0 |   16.07 | 26-122,130-134,151-157                                                                                                                                                                                                                                                                                    
  recording-metrics.ts            |    8.98 |        0 |       0 |    9.63 | 40-74,87-121,131-197,211-243,253-321                                                                                                                                                                                                                                                                      
  recording-upload-retry.ts       |    5.76 |        0 |       0 |    5.82 | 28-236,245-285,293-300                                                                                                                                                                                                                                                                                    
  redaction-service.ts            |   10.52 |        0 |       0 |   11.11 | 26-60                                                                                                                                                                                                                                                                                                     
  secrets-manager.ts              |    8.45 |        0 |       0 |    8.45 | 19-29,40-189,202-215,226-242                                                                                                                                                                                                                                                                              
  sentiment-analysis.ts           |   15.15 |        0 |       0 |   16.66 | 24-97                                                                                                                                                                                                                                                                                                     
  settings-cache.ts               |   31.25 |        0 |       0 |   31.25 | 8-23                                                                                                                                                                                                                                                                                                      
  sms-compliance-service.ts       |   35.29 |        0 |       0 |   35.29 | 12-43                                                                                                                                                                                                                                                                                                     
  sms-notifications.ts            |    7.95 |        0 |       0 |    7.95 | 15-62,86-129,141-192,204-251,263-295                                                                                                                                                                                                                                                                      
  supabase-client.ts              |   82.35 |       60 |      50 |   86.66 | 21,50                                                                                                                                                                                                                                                                                                     
  twilio-service.ts               |   12.24 |        0 |       0 |   12.24 | 43-68,79-121,136-173,189-191,206-208                                                                                                                                                                                                                                                                      
  vapi-booking-handler.ts         |     8.1 |        0 |       0 |     8.1 | 50-262,279-331                                                                                                                                                                                                                                                                                            
  vapi-client.ts                  |   16.32 |     6.66 |   14.58 |   18.25 | 106,131-165,172-174,178-188,194-199,209-461,469-673                                                                                                                                                                                                                                                       
  vapi-webhook-configurator.ts    |   10.52 |        0 |       0 |    10.9 | 14-19,41-159,173-194                                                                                                                                                                                                                                                                                      
  web-voice-bridge.ts             |    8.61 |        0 |    3.84 |    8.82 | 56-115,130-144,165-434,451-584,591-611,618,625                                                                                                                                                                                                                                                            
  websocket.ts                    |   13.79 |     2.85 |    5.26 |   14.59 | 18-26,81-185,200-218,225,232,242-295,302-312                                                                                                                                                                                                                                                              
 src/tests/regression/utils       |   90.54 |    54.16 |   83.33 |   95.16 |                                                                                                                                                                                                                                                                                                           
  regression-setup.ts             |   90.54 |    54.16 |   83.33 |   95.16 | 79,125,139                                                                                                                                                                                                                                                                                                
 src/types                        |   85.71 |    66.66 |   33.33 |   85.71 |                                                                                                                                                                                                                                                                                                           
  call-outcome.ts                 |   85.71 |    66.66 |   33.33 |   85.71 | 52,65,80,91-111                                                                                                                                                                                                                                                                                           
 src/utils                        |   16.45 |      0.9 |       0 |   17.18 |                                                                                                                                                                                                                                                                                                           
  encryption.ts                   |      25 |       25 |       0 |      25 | 7,16-29,38-58                                                                                                                                                                                                                                                                                             
  google-calendar.ts              |      10 |        0 |       0 |      10 | 20-85,107-135,157-212,230-298                                                                                                                                                                                                                                                                             
  otp-utils.ts                    |    23.8 |        0 |       0 |      25 | 12-15,25-26,35,45-58                                                                                                                                                                                                                                                                                      
  phone-validation.ts             |   22.22 |        0 |       0 |   22.22 | 14,25-52,63-69                                                                                                                                                                                                                                                                                            
  sanitize.ts                     |   17.64 |        0 |       0 |   21.42 | 6-8,22-24,31-39                                                                                                                                                                                                                                                                                           
  timeout-helper.ts               |   14.28 |        0 |       0 |   16.66 | 12-19                                                                                                                                                                                                                                                                                                     
  vapi-webhook-signature.ts       |      20 |        0 |       0 |      25 | 4,25-36,40-42,46-48                                                                                                                                                                                                                                                                                       
  webhook-org-resolver.ts         |   15.55 |        0 |       0 |   15.55 | 32-71,91-135,144-151,160-167                                                                                                                                                                                                                                                                              
----------------------------------|---------|----------|---------|---------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Test Suites: 1 failed, 1 total
Tests:       3 failed, 8 passed, 11 total
Snapshots:   0 total
Time:        20.876 s, estimated 23 s
Ran all test suites.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
